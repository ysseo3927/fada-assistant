<!-- Fire Apparatus Data Analysis -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="./resources/vendor/jquery/jquery.min.js"></script>
    
    <script src="./resources/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="./resources/vendor/jquery-easing/jquery.easing.min.js"></script>
    <!-- <link rel="icon" type="image/png" sizes="192x192"  href="/resources/img/ms-icon-70x70.png"> -->
    <script src="./resources/vendor/html2canvas/html2canvas.js"></script>

    <script src="./resources/vendor/chart.js/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="./resources/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script src="./resources/vendor/sqljs/sql.js"></script>
    <!-- 건물 착공 데이터 import -->
    <script src="./resources/js/refer-data.js"></script>

    <link rel="stylesheet" type="text/css" href="./resources/vendor/bootstrap/css/bootstrap.min.css"></link>
    <link rel="stylesheet" type="text/css" href="./resources/vendor/fontawesome-free/css/all.min.css"></link>
    <style>

        label {
            display: inline-block;
            margin: 0 0 -1px;
            padding: 15px 25px;
            font-weight: 600;
            text-align: center;
            color: #bbb;
            border: 1px solid transparent;}

        label:hover {
            color: #2e9cdf;
            cursor: pointer;
        }

    </style>
</head>
<body style="font-family:'Malgun Gothic';">
    <div id="wrap" style="margin: auto;width:80%;">
        <div id="header-wrap">
            <div id="title-left" style="float:left;height:70px;width:60%;margin-bottom:5px;">
                <img src="./resources/img/fada_logo.png" alt="Fada Assistant">
            </div>
            <div id="header-right" style="float:left;height:50px;width:40%;text-align:right;">
                <label class="m-0 font-weight-bold">
                    <a href="#" data-toggle="modal" onclick="showInfo();" data-target="#info-modal">Fada Assistant v1.0.0</a>
                </label>
            </div>
        </div>

        <div id="file-content">
            <input id="fileInput" filestyle="" type="file" onchange="upload(event);" accept=".xlsx" data-class-button="btn btn-default" data-class-input="form-control" data-button-text="" data-icon-name="fa fa-upload" class="form-control" tabindex="-1" style="position: fixed; clip: rect(0px 0px 0px 0px);">
            <div class="bootstrap-filestyle input-group">
                <input type="text" id="userfile" class="form-control" name="userfile" disabled="">
                <span class="group-span-filestyle input-group-btn" tabindex="0">
                    <label for="fileInput" class="btn btn-secondary"  style="border-top-left-radius:0;border-bottom-left-radius:0;">파일 업로드
                        <span class="glyphicon fa fa-upload"></span>
                    </label>
                </span>
            </div>
        </div>
        <hr>

        <div id="tab-content" style="padding:10px;border:1px solid rgb(211, 211, 211)">
            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="home-tab" data-toggle="tab" href="#tab1" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="true">전체</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="profile-tab" data-toggle="tab" href="#tab2" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="false">업체별 합격수량 비율</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#tab3" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="false">기간별 업체별 합격수량</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#tab4" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="false">기간별 업체별 품목 증가 추이</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#tab5" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="false">기간별 제품 합격수량/전년 대비 데이터 추이</a>
                    </li>
                    <li class="nav-item">
                    <a class="nav-link" id="contact-tab" data-toggle="tab" href="#tab6" style="border-top-left-radius:0;border-top-right-radius:0;font-weight: bold;" aria-selected="false">건물 착공 데이터 소방품목 데이터 비교</a>
                    </li>
                </ul>
                <div class="tab-content" id="tabContent" style="border:1px solid rgb(211, 211, 211);padding-top:10px;padding-left:10px;padding-right:10px;">
                    <div class="tab-pane fade show active" id="tab1">
                    <!--
                    <div id="upload-description" style="height:500px;padding-top:200px;text-align:center">
                    <img src="./resources/img/upload_description.png"></img>
                    </div>
                    -->

                        <div class="row">

                            <!-- Area Chart -->
                            <div style="width:50%;">
                                <div class="card shadow mb-4" style="border-radius:0px;">
                                    <!-- Card Header - Dropdown -->
                                    <div
                                            class="card-header d-flex flex-row align-items-center justify-content-between">
                                        <img src="./resources/img/header1.png"><!-- <h6 class="m-0 font-weight-bold" style="color:#51545c">업체별 합격수량 비율</h6> -->
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body" style="text-align: center;margin:auto;">
                                       <div><canvas id="chart1"  style="width:100%;height:300px"></canvas></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Area Chart -->
                            <div style="width:50%;">
                                <div class="card shadow mb-4" style="border-radius:0px;">
                                    <!-- Card Header - Dropdown -->
                                    <div
                                            class="card-header d-flex flex-row align-items-center justify-content-between">
                                            <img src="./resources/img/header2.png">
                                        <div class="dropdown no-arrow">
                                        </div>

                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body" style="text-align: center;margin:auto;">
                                        <div id="chart2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">

                            <!-- Area Chart -->
                            <!-- Area Chart -->
                            <div style="width:50%;">
                                <div class="card shadow mb-4" style="border-radius:0px;">
                                    <!-- Card Header - Dropdown -->
                                    <div
                                            class="card-header d-flex flex-row align-items-center justify-content-between">
                                            <img src="./resources/img/header3.png">
                                        <div class="dropdown no-arrow"></div>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div id="chart3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Area Chart -->
                            <div style="width:50%;">
                                <div class="card shadow mb-4" style="border-radius:0px;">
                                    <!-- Card Header - Dropdown -->
                                    <div
                                            class="card-header d-flex flex-row align-items-center justify-content-between">
                                            <img src="./resources/img/header4.png">
                                        <div class="dropdown no-arrow"></div>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div id="chart4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                </div>
                <div class="tab-pane fade" id="tab2">
                    <div style="margin:auto;"><div id="chart1-detail"></div></div>
                </div>
                <div class="tab-pane fade" id="tab3">
                    <div style="margin:auto;"><div id="chart2-detail"></div></div>
                </div>
                <div class="tab-pane fade" id="tab4">
                    <div style="margin:auto;"><div id="chart3-detail"></div></div>
                </div>
                <div class="tab-pane fade" id="tab5">
                    <div style="margin:auto;"><div id="chart4-detail"></div></div>
                </div>
              </div>
        </div>
    </div>

    <div class="modal fade" id="info-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title m-0">정보</h6>
                </div>
                <div class="modal-body">
                    <span style="font-weight: bold;"><h5>Fada Assistant</h5></span>

                    <span>Description : Assistant for fire apparatus data analysis</span><br>
                    <span>Version : 1.0.0</span><br>
                    <span>Release : 2022. 09</span>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="hideInfo()" class="btn btn-primary" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    
    var db = new SQL.Database();
    
    $(document).ready(function(){
    
        db.run("CREATE TABLE _EXCEL1_ORIGIN_DATA (X1_ID, X1_DATE, X1_YEAR, X1_YEAR_MONTH, X1_COMPANY, X1_AMOUNT);");
    // Insert two rows: (1,111) and (2,222)
    /*
    db.run("INSERT INTO test(col1, col2) VALUES ('1','값1')");
    db.run("INSERT INTO test(col1, col2) VALUES ('2','값2')");
    // Prepare a statement
    var stmt = db.prepare("SELECT * FROM test");
    //var result = stmt.getAsObject(); // {col1:1, col2:111}
    while(stmt.step()){
        var data = stmt.getAsObject();
        alert(JSON.stringify(data));
    }
    */
        $("#fileInput").on('change', function(){  // 값이 변경되면
            if(window.FileReader){  // modern browser
                var filename = $(this)[0].files[0].name;
                $("#userfile").val($(this)[0].files[0].path);
            } else {  // old IE
                var filename = $(this).val().split('/').pop().split('\\').pop();  // 파일명만 추출
            }

            // 추출한 파일명 삽입
            //$("#userfile").val(filename);
        });

        $('#myTab a').on('click', function (event) {
                event.preventDefault()
                $(this).tab('show')
        });
    
    });

    function showInfo(){
        $("#info-modal").modal('show');
    }

    function hideInfo(){
         $("#info-modal").modal("hide");

    }
    
    function upload(event){
        var input = event.target;
        var reader = new FileReader();
        reader.onload = function(){
            var fdata = reader.result;
            var read_buffer = XLSX.read(fdata, {type : 'binary'});
            read_buffer.SheetNames.forEach(function(sheetName){
                var rowdata =XLSX.utils.sheet_to_json(read_buffer.Sheets[sheetName]);
                setOriginData(JSON.stringify(rowdata));
            })
        };
        reader.readAsBinaryString(input.files[0]);
    }

    function setOriginData(originData){
        let parsedOriginData = JSON.parse(originData);

        for(var i=0; i<parsedOriginData.length; i++){
            var date = parsedOriginData[i].일자;
            var year = parsedOriginData[i].일자.substr(0,4);
            var year_month = parsedOriginData[i].일자.substr(0,7);
            var company = parsedOriginData[i].업체명;
            var amount = parsedOriginData[i].수량;
            db.run("INSERT INTO _EXCEL1_ORIGIN_DATA VALUES ("+(i+1)+", '"+date+"','"+year+"','"+year_month+"','"+company+"', "+amount+")");
        }

        analysisData();
    }

    function analysisData(){
        analysisData1();
        analysisData2();
    }

    function analysisData1(){
        var stmt1 = db.prepare("SELECT MAX(X1_YEAR) AS max_year ,MIN(X1_YEAR) AS min_year FROM _EXCEL1_ORIGIN_DATA");
        var data1 = stmt1.getAsObject(0);
        var parsedData1 = JSON.parse(JSON.stringify(data1));
        var maxYear = parsedData1.max_year;
        var minYear = parsedData1.min_year;
        
        var stmt2 = db.prepare("SELECT X1_COMPANY, SUM(X1_AMOUNT) AS X1_AMOUNT FROM _EXCEL1_ORIGIN_DATA WHERE X1_YEAR = '" +maxYear+ "' GROUP BY X1_COMPANY ORDER BY X1_AMOUNT DESC");
        
        var companyMap = new Map();
        var sumAmount = 0;

        while(stmt2.step()){
            var data2 = stmt2.getAsObject();
            var parsedData2 = JSON.parse(JSON.stringify(data2));
            var company = parsedData2.X1_COMPANY;
            var amount =  parsedData2.X1_AMOUNT;
            sumAmount += parseInt(amount);
            companyMap.set(company, amount);
        }
        
        var chart1Labels = [];
        var chart1Datas = [];
        for(const key of companyMap.keys()){
            let value = companyMap.get(key);
            var fixData = parseFloat(parseFloat(value/sumAmount*100).toFixed(2));
            chart1Labels.push(key+"("+fixData+"%)");
            chart1Datas.push(fixData);
        }
        //alert(chart1Datas.join(","));
        chart1.data.labels = chart1Labels;
        chart1.data.datasets[0].data = chart1Datas;
        
        //chart1.data.labels = ["아","로","하"];
        //chart1.data.datasets[0].data = [20,30,50];

        chart1.update();
        //alert(_BUILDING_AREA_DATA.get("2021"));
        //alert(JSON.stringify(data));
    }

    function analysisData2(){
        var stmt1 = db.prepare("SELECT MAX(X1_YEAR) AS max_year ,MIN(X1_YEAR) AS min_year FROM _EXCEL1_ORIGIN_DATA");
        var data1 = stmt1.getAsObject(0);
        var parsedData1 = JSON.parse(JSON.stringify(data1));
        var maxYear = parsedData1.max_year;
        var minYear = parsedData1.min_year;

          
    }
</script>
<script>

    Chart.register(ChartDataLabels);

    var chart1 = new Chart(document.getElementById("chart1"), {
        type: 'pie',
        data: {
            labels: [
                ''
            ],
            datasets: [{
                label: '',
                data: [100],
                backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)'
                ],
                hoverOffset: 4
            }]
            },
        options: {
            layout: {
            padding: {
                top: 30,
                bottom:30,
                left:30,
                right:30
            }
        },
            title: {
                display: false
            },
            responsive: false,
            plugins: {
                    legend: {
                        display: true,
                        position : 'left',
                        fullSize : true,
                        labels : {
                            usePointStyle : true,
                            padding :7
                        }
                    },
                    datalabels: {
                        anchor:'end',
                        align:'end',
                        backgroundColor: function (context) {
                            return context.dataset.backgroundColor;
                        },
                        borderColor: 'white',
                        borderRadius: 3,
                        borderWidth: 0,
                        color: function (context) {
                            return context.hovered ? 'black' : 'black'
                        },
                        font: {
                            weight: 'bold'
                        },
                        listeners: {
                            enter: function (context) {
                                context.hovered = true;
                                return true;
                            },
                            leave: function (context) {
                                context.hovered = false;
                                return true;
                            }
                        },
                        display: true,
                        formatter: function (value, context) {
                            let percentage = context.dataset.data[0] + "%";
                            return percentage;
                        }.bind(this)
                    },
                },
        }
    });
</script>
</html>